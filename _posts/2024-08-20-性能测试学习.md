---
layout:     	post
title:      	性能测试学习
subtitle:    	
date:       	2024-08-20
author:     	Rorschach
header-img:		img/post-bg-keybord.jpg
catalog: true

tags:
    - 软件测试
    - 学习

---





# 性能测试学习



## 1 基本理论

### 1.1 基本概念

性能：

- 时间：系统处理用户请求的响应时间
- 资源：系统运行过程中，资源的消耗情况

性能测试：使用自动化工具，模拟不同场景，对软件各项性能指标进行测试和评估的过程

- 评估当前系统能力
- 寻求性能瓶颈，优化性能
- 评估软件能否满足未来需要



一般功能测试通过后进行性能测试



### 1.2 性能测试分类

#### 基准测试

在没有负载的情况下测试系统，以确定其在正常操作条件下的性能

- 单用户测试
- 建立基准线，当系统软硬件环境发生变化后再进行基准测试以确定变化对性能的影响

用途：

- 基准测试不会单独存在
- 为多用户并发测试和综合场景测试提供参考依据
- 为系统/环境配置、系统优化前后的性能提升/下降提供参考指标



#### 负载测试

通过逐步增加系统负载，确定在满足系统的性能指标情况下，找到系统所能承受的最大负载量的测试

系统最大负载量达到用户要求时，系统才能正式上线使用

- 通过负载测试，可以确定系统的最大负载量和极限负载量
- 系统对外宣称的最大负载量
- 负载测试的时间一般为1-2小时



#### 稳定性测试

评估系统在持续运行或压力条件下的行为和性能的测试方法。它主要关注系统在长时间运行过程中的可靠性、错误处理能力以及在异常情况下的恢复能力

- 恒定压力
- 压力变化
- 异常干扰



#### 压力测试

在强负载下查看系统在峰值情况下是否存在功能隐患，是否具有良好的容错能力和可恢复能力

场景：

- 高负载下的长时间稳定性压力测试
- 极限负载情况下的破坏性压力测试



#### 并发测试

并发测试是指在极短时间内，发送多个请求，验证服务器对并发的处理能力，发现可能的并发问题，例如内存泄漏、线程锁和资源争用等





### 1.3 性能测试指标

#### 响应时间

客户端发起请求到接受结果的时间

服务器处理时间 + 网络传输时间



#### 并发用户数

某一时刻同时向服务器发送请求的用户数



#### 吞吐量

Throughput 单位时间内处理的客户端请求数量，直接体现系统的性能承载能力



QPS（Query Per Second）每秒查询数：控制服务器每秒处理的指定请求的数量

TPS（Transactions Per Second）每秒事务数：控制服务器每秒处理的事务请求的数量



#### 点击量

所有页面的请求总量，注意是请求数



#### 错误率

系统在负载情况下，业务失败的概率

是性能指标

随机 bug 是功能 bug ，要先解决随机 bug 才能进行性能测试



#### 资源利用率

系统各种资源的使用情况

1. CPU使用率                         不高于75%-85%
2. 内存使用率                         不该与80%
3. 磁盘IO                                不高于90% 
4. 网络                                    不高于80%



### 1.4 性能测试流程

1. 需求分析
2. 测试计划与方案
3. 用例设计
4. 用例执行
5. 性能分析与调优
6. 测试报告



#### 需求分析

被测系统：

1. 业务功能
2. 技术架构

测试内容：

1. 业务角度：用户使用频率高的业务功能
2. 技术角度：逻辑复杂度高、数据量大的业务

测试策略：

1. 负载测试
2. 稳定性测试
3. 并发测试
4. ...

测试指标：

1. 有明确指标
2. 无明确指标，分析、预估



#### 性能测试计划

1. 测什么
   - 项目背景
   - 测试目的
   - 测试范围
2. 谁来测
   - 进度与分工
   - 交付清单
3. 怎么测
   - 测试策略



#### 用例设计

| 用例名称 | 获取首页数据                           |
| -------- | -------------------------------------- |
| 用例编号 | case002                                |
| 用例描述 | TPS达到100情况下，进入首页时间不超过5s |
| 前置条件 | 首页存在10万数据                       |
| 用例步骤 | 进入首页                               |

<table>
<thead>
<tr>
<th>用例名称</th>
<th colspan="4">获取首页数据</th>
</tr>
</thead>
<tbody>
<tr>
<td>用例编号</td>
<td colspan="4">Case002</td>
</tr>
<tr>
<td>用例描述</td>
<td colspan="4">TPS达到100情况下，进入首页时间不超过5s</td>
</tr>
<tr>
<td>前置条件</td>
<td colspan="4">准备10万商品数据</td>
</tr>
<tr>
<td>用例步骤</td>
<td colspan="2">动作</td>
<td colspan="2">预期性能</td>    
</tr>
<td>1</td>
<td colspan="2">进入商城首页</td>
<td colspan="2"><5s </td>    
</tr>
</tr>
<td>2</td>
<td colspan="2"></td>
<td colspan="2"> </td>    
</tr>
<tr>
    <td colspan="5" style="text-align:center; font-weight:bold">并发用户数与事务响应</td>
</tr>
<tr>
	<td>并发用户数</td>
    <td>事务平均响应时间</td>
    <td>事务最大响应时间</td>
    <td>TPS</td>
    <td>事务成功率</td>
</tr>
<tr>
	<td>5</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
	<td>10</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
	<td>30</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
	<td>50</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
	<td>100</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
    <td colspan="5" style="text-align:center; font-weight:bold">并发用户数与服务器性能</td>
</tr>
<tr>
	<td>并发用户数</td>
    <td>CPU利用率</td>
    <td>内存利用率</td>
    <td>磁盘IO情况</td>
    <td>其他参数</td>
</tr>
<tr>
	<td>5</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
	<td>10</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
	<td>30</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
	<td>50</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
	<td>100</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
    <td colspan="5" style="text-align:center; font-weight:bold">并发用户数与数据库性能</td>
</tr>
<tr>
	<td>并发用户数</td>
    <td>CPU利用率</td>
    <td>内存利用率</td>
    <td>磁盘IO情况</td>
    <td>其他参数</td>
</tr>
<tr>
	<td>5</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
	<td>10</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
	<td>30</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
	<td>50</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
<tr>
	<td>100</td>
    <td></td>
    <td></td>
    <td></td>
    <td></td>
</tr>
</tbody>
</table>




#### 用例执行

1. 建立测试环境：包括硬件环境、软件环境、网络环境，和开发、运维一起完成
2. 编写测试脚本：代码或工具
3. 性能测试监控：脚本执行前，配置各项性能的监控指标
4. 执行测试脚本：执行并收集指标



#### 测试报告

1. 测试工作经过回顾
2. 缺陷分析与调优
3. 风险评估
4. 性能测试结果
5. 测试工作总结与改进



## 2 性能测试工具 Jmeter

#### Jmeter 安装

1. 安装 JDK 并配置环境变量
2. 下载安装 [Jemter](https://jmeter.apache.org/download_jmeter.cgi) 
3. 解压后，bin 目录下打开 Jemter.bat 
4. 插件管理下载 ，下载 [plugins-manager.jar](https://jmeter-plugins.org/install/Install/) 并放入 lib/ext 目录，然后重新启动 JMeter
5. 可选汉化，配置 bin 目录下 jmeter.properties



#### 基本使用

线程组：模拟一组用户（可以是多个用户）

1. Setup线程组：预测试操作，所有脚本之前执行
2. 普通线程组：执行测试用例，可以有1个或多个（并行/串行）
3. Teardown线程组：测试后操作，所有脚本之后可执行



HTTP请求

查看结果树





#### 参数化

把测试数据组织起来，用不同的测试数据调用相同的测试方法

- 用户定义的变量
- 用户参数
- CSV文件
- 函数



#### 自动化测试脚本流程

| 初始化测试数据                   | 配置元件   |
| -------------------------------- | ---------- |
| 对请求参数进行赋值               | 前置处理器 |
| 调用 GET/POST 方法               | 取样器     |
| 提取响应中特定字段               | 后置处理器 |
| 对提取出来的值与预期结果进行对比 | 断言       |
| 在控制台查看脚本运行结果         | 监听器     |



## 3 meter 使用

#### 断言

让程序自动判断预期结果和实际结果是否一致

- 响应断言
- JSON 断言
- 持续时间断言



#### 关联

当请求之间有依赖关系，一个请求的入参是零一个请求返回的数据

- 正则表达式 提取器（任意格式）
- XPath 提取器（HTML）
- JSON 提取器



##### 正则表达式

一个公式/规则，从任意字符串中提取出想要的数据内容

```
. 				通配符
*				代表前面的字符出现0次或多次
.*				匹配任意
?				非贪婪匹配，找到左边界后，往右匹配右边界，再次查找左边界和右边界

左边界(.*?)右边界
```

```
021-1234-1234
022-1234-1235
023-1234-1236
024-1234-1237
025-1234-1238
026-1234-1239
027-1234-1230

(.*?)-(.*?)-(.*?)\n
```



通过一个正则表达式可以提取多组数据，每组设置对应的左边界和有边界

每一组数据都可以有一个或多个值



测试计划 -->  线程组 -->  HTTP请求 -->  后置处理器  -->  正则表达式提取器



引用名称：存放提取出来的值的参数名称，供下一个请求引用，如填写 xyz ，可以通过 ${xyz} 引用它

正则表达式： (.*?)

模板： 用 $$ 引用，在正则表达式中有多个提取值，则可以 $2$ 等表示解析到的第几个值给 xyz

匹配数字：0代表随机，1代表取第一个值，-1代表全部取值（存在列表中，用 xyz_3 取）

缺省值：若参数没有取到值，默认给值



##### XPath

针对 HTML 格式数据提取

测试计划 -->  线程组 -->  HTTP请求 -->  后置处理器  -->  XPath 提取器



Use Tidy (tolerant parser) ：处理 HTML 必须选中，处理 XML 或 XHTML 取消选中

引用名称：存放参数名称

XPath Query：表达式

匹配数字：0代表随机，1代表取第一个值，-1代表全部取值

缺省值：若参数没有取到值，默认给值

XPath 定位

```
//title
```



##### JSON 

针对 JSON 格式数据提取

Names of created variables ：参数

JSON Path expressions ：JSON表达式

Match No. ：0代表随机，1代表取第一个值

Default Values ： 若参数没有取到值，默认给值



##### 属性

局部变量难以在别的取样器使用



__setProperty : 将值保存成 JMeter 属性，需要通过 BeanShell 取样器执行

__property : 在其他线程组中读取属性





#### 直连数据库

1. 请求参数化（例如数据库里存储账密，参数化登录）
2. 结果断言（数据校验）
3. 清理垃圾数据（脚本下册执行前删除已添加的数据）
4. 准备测试数据（数据库存储测试数据）



1. 启动数据库
2. 配置 jar 包， 加载 jar 包 mysql-connector-j-9.0.0.jar 放在 lib/ext 目录下
3. 配置数据库连接信息：连接池名称、数据库信息（协议 + 数据库IP + 数据库端口 + 连接的数据库名称）（jdbc:mysql://127.0.0.1:3306/database）、数据库驱动包、数据库用户名和密码
4. 添加 JDBC 请求：数据库连接池名称、Query Type、SQL语句、查询结果保存的变量名



#### 逻辑控制器

按照设定的逻辑控制取样器的执行顺序

1. if
2. 循环
3. ForEach



##### if 控制器

1. 添加线程组
2. 用户定义的变量
3. if 控制器，判断
   - 不勾选 interpret condition as variable expression: "${name}" == "baidu"
   - 勾选 interpret condition as variable expression: ${__jexl3("${name}" == "baidu",)}
4. 添加 http 请求
5. 查看结果树



##### 循环控制器

设置循环次数，实现循环发送请求

1. 添加线程组
2. 添加循环控制器
3. 添加请求
4. 查看结果树

线程组控制所有的请求，循环控制器控制其下的请求



##### ForEach 控制器

和用户定义的变量或正则表达式提取器一起使用，读取返回结果中一系列相关的变量

- 输入变量前缀：要读取的输入变量的固定前缀
- 开始循环字段：要读取的输入变量后缀数字的最小值 - 1
- 结束循环字段：要读取的输入变量后缀数字的最大值
- 输出变量名称：保存的新的变量名



#### 定时器

同步计时器：阻塞线程（累积到一定的请求数量），当在规定的时间内达到一定的线程数量，这些线程会在同一个时间点一起释放，瞬间产生很大的压力

Synchronizing Timer



常数吞吐量定时器：让 Jmeter 按指定的吞吐量执行，以分钟为单位

Constant Throughput Timer

目标吞吐量：每个用户每分钟发送的请求数



固定定时器：等待固定时间

